<?php
// $Id$

/**
 * @file
 * Provides Community Media Checklist functions
 */

/**
 * Implements hook_menu().
 */
function cm_checklist_menu() {
  
  // Adds Community Media Section to Admin Interface
  // Duplicated in cm_show and cm_project, first module installed creates the link
  $items['admin/config/communitymedia'] = array(
    'title' => t('Community Media'),
    'description' => t('Configuration options for Community Media modules'),
    'position' => 'right',
    'page callback' => 'system_admin_menu_block_page',
    'access arguments' => array('access administration pages'),
    'file' => 'system.admin.inc',
    'file path' => drupal_get_path('module', 'system'),
    'weight' => -99,
  );
  
  $items['admin/reports/communitymedia-checklist'] = array(
    'title' => t('Community Media Checklist'),
    'description' => t('Display configuration status'),
    'page callback' => 'cm_checklist_main',
    'access arguments' => array('access administration pages'),
    'weight' => -99,
    'file' => 'cm_checklist.report.inc',
  );
    
  $items['admin/config/communitymedia/checklist'] = array(
    'title' => t('Checklist Configuration'),
    'description' => t('Configuration options for the Community Media Checklist.'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('cm_checklist_admin_settings'),
    'access arguments' => array('access administration pages'),
    'type' => MENU_NORMAL_ITEM,
  );
  
  return $items;
}

/**
 * Implements hook_help().
 */
function cm_checklist_help($path, $arg) {
  switch ($path) {
    case 'admin/configure/communitymedia/checklist':
      $output = '<p>' . t('The modules developed for Community Media are designed to be implemented incrementally based on each station\'s needs.  This is not an exhaustive checklist, but designed to help you work through the configuration process.') . '</p>';
      
      return $output;
  }
}

/**
 * Builds the cm_checklist administration settings form.
 */
function cm_checklist_admin_settings($form, &$form_state) {
  $form = array();
  
  if (!variable_get('cm_checklist_drupal_uid', 0)) {
    $form['cm_checklist_markup'] = array(
      '#type' => 'item',
      '#title' => t('Getting Involved'),
      '#markup' => t('If you already have a Drupal.org account, <a href="@url">here is how you find the user id</a>.  If you do not have account, you can create one now.', array('@url' => url('https://www.drupal.org/user'))),
    );
  
    $form['cm_checklist_drupal_uid'] = array(
      '#type' => 'textfield',
      '#title' => t('Drupal User ID'),
      '#default_value' => variable_get('cm_checklist_drupal_uid', 0),
      '#description' => t(''),
    );
  } else {
    $form['cm_checklist_markup'] = array(
      '#type' => 'item',
      '#title' => t('Congratulations!'),
      '#markup' => t('You\'ve already registered your Drupal ID. <a href="@url">Let\'s look at the next step in the Checklist Report</a>.', array('@url' => url('admin/reports/communitymedia-checklist'))),
    );
  }
  return system_settings_form($form);
}


/**
 * Checks the Status of the CiviCRM configuration.
 */
function cm_checklist_civicrm_status(){
 
  //CHECK 1 - CiviGroup Roles or CiviGroup Group Sync configured?
  if (!module_exists('civicrm_member_roles') && !module_exists('civicrm_group_roles') ) {
    $status = array(
    'description' => t('CiviCRM is installed, but neither CiviGroup Roles and CiviGroup Group Sync are configured.  This is how information membership and certification information is shared between Drupal and CiviCRM.  <a href="@url">Step by step instructions for configuring CiviGroup Roles and CiviGroup Group Sync</a>', array('@url' => url('http://drupal.org/node/1013546'))),
    'severity' => 2,);
    return $status;
  }
  
  //if there are no problems, return this
  $status = array(
    'description' => t('See the <a href="@url">CiviCRM configuration checklist</a> for additional steps to that configuration.', array('@url' => url('/civicrm/admin/configtask'))),
    'severity' => 0,);
  return $status;
}

/**
 * Checks the Status of the Reservations API configuration.
 */
function cm_checklist_reservations_status(){
  
  //CHECK 1 - Check to see if any content types have been created
  $reservations_item_count = db_query("SELECT COUNT(type) FROM {reservations_node_type} WHERE reservations_type_setting = :bucket OR reservations_type_setting = :resource", array(':bucket' => 'bucket', ':resource' => 'resource'))->fetchField();
  
  if (!$reservations_item_count) {
    $status = array(
    'description' => t('You have not configured any content types to be Buckets or Resources.  Please follow the <a href="@url">step by step instructions for configuring Reservations managed content types</a>', array('@url' => url('http://drupal.org/node/1043510'))),
    'severity' => 2,);
    return $status;
  }
  
  //if there are no problems, return this
  $status = array(
    'description' => t('Reservations is configured correctly.'),
    'severity' => 0,);
  return $status;
}

/**
 * Checks the Status of the Legal module configuration.
 */
function cm_checklist_legal_status(){
  $conditions = legal_get_conditions();
  if(!$conditions['tc_id']) {
  
    $link = t('<a href="@url">Terms & conditions</a>', array('@url' => url('admin/config/people/legal')));
    $status = array(
      'description' => t('Legal is enabled, but not configured.  Please add your site\'s ') . $link,
      'severity' => 1,);
    return $status;
  }
  //if there are no problems, return this
  $status = array(
    'description' => t('Legal is configured correctly.'),
    'severity' => 0,);
  return $status;
}

/**
 * Checks to see if the Drupal.org uid has been saved 
 * AND that at least one page of documentation has been added or edited
 */
function cm_checklist_documentation_status(){
  
  if(variable_get('cm_checklist_drupal_uid', 0) < 1) {
  
    $link = t('<a href="@url">To continue, add your Drupal.org user id here</a>.', array('@url' =>('admin/config/communitymedia/checklist')));
    $status = array(
      'description' => 'In order to contribute to the documentation, you must have an account on Drupal.org.  ' . $link,
      'severity' => 1,);
    return $status;
  }
  
  //if there are no problems, return this
  $status = array(
    'description' => t('You have shown that you can edit documentation on Drupal.org.'),
    'severity' => 0,);
  return $status;
}


/**
 * Checks to see if the Drupal.org uid has been saved 
 * AND that at least one page of documentation has been added or edited
 */
function cm_checklist_status(){
  //if there are no problems, return this
  $status = array(
    'description' => t('Checklist needs a Drupal.org ID to continue the configuration.'),
    'severity' => 0,);
  return $status;
}
